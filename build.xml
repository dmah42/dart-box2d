<?xml version="1.0" encoding="UTF-8"?>
<project name="DartBox2D" default="default">
  <!-- Expect ant-contrib 1.0b5 available -->
  <taskdef resource="net/sf/antcontrib/antcontrib.properties"/>

  <property environment="env" />
  <fail message="ERROR: Please set environmental variable DART_SDK"> 
    <condition> 
      <not> 
        <isset property="env.DART_SDK" /> 
      </not> 
    </condition> 
  </fail>

  <property name="dart.sdk.dir" value="${env.DART_SDK}" />
  <property name="dartdoc.dart" value="${dart.sdk.dir}/bin/dartdoc" />
  <property name="dart_analyzer" value="${dart.sdk.dir}/bin/dart_analyzer" />
  <property name="dart_analyzer.args" value="--enable_type_checks" />

  <!-- Set envvar DB2D_WITH_CHECKS to compile with checks. -->
  <condition property="withChecks" value="true">
    <isset property="env.DB2D_WITH_CHECKS"/>
  </condition>
  <property name="withChecks" value="false" />

  <!-- Set envvar DB2D_THREAD_COUNT to parallelize.
       May affect output readability. -->
  <condition property="threadCount" value="${env.DB2D_THREAD_COUNT}">
    <matches pattern="^\d+$" string="${env.DB2D_THREAD_COUNT}"/>
  </condition>
  <property name="threadCount" value="1" />

  <path id="demos">
    <fileset dir="example/demos">
      <include name="*.dart" />
      <exclude name="demo.dart" />
      <include name="racer/racer.dart" />
    </fileset>
  </path>

  <macrodef name="dart_analyze">
    <attribute name="file" />
    <sequential>
      <echo>Analyzing @{file}</echo>
      <exec executable="${dart_analyzer}" failonerror="true">
        <arg line="${dart_analyzer.args} @{file}" />
      </exec>
    </sequential>
  </macrodef>

  <macrodef name="dartdoc">
    <attribute name="file" />
    <attribute name="outDir" />
    <sequential>
      <echo>Documenting "@{file}" into "@{outDir}"</echo>
      <exec executable="${dart.sdk.dir}/bin/dart" failonerror="true">
        <arg line="${dartdoc.dart} --out=@{outDir} @{file}" />
      </exec>
    </sequential>
  </macrodef>

  <macrodef name="dart2js">
    <attribute name="file" />
    <attribute name="withChecks" default="false" />

    <sequential>
      <local name="dart2js.args" />
      <if>
        <istrue value="@{withChecks}" />
        <then>
          <property name="dart2js.args" value="-c" />
        </then>
        <else>
          <property name="dart2js.args" value="" />
        </else>
      </if>

      <echo>Generating JS "@{file}.js" from "@{file}"</echo>
      <exec executable="${dart.sdk.dir}/bin/dart2js" failonerror="true">
        <arg line="${dart2js.args} -o@{file}.js @{file}"/>
      </exec>
    </sequential>
  </macrodef>

  <!-- MAIN -->
  <target name="default"
    depends="analyze, generate-JS, generate-doc"
    description="Analyze, generate JS and library's DartDoc." />

  <target name="analyze"
    depends="analyze-lib, analyze-demos, analyze-benchmarks"
    description="Run dart_analyzer over library and all demos." />

  <target name="analyze-lib">
    <dart_analyze file="lib/box2d_nohtml.dart" />
    <dart_analyze file="lib/box2d.dart" />
  </target>

  <target name="analyze-demos">
    <for param="file" trim="true" parallel="true" threadCount="${threadCount}">
      <path refid="demos" />
      <sequential>
        <dart_analyze file="@{file}" />
      </sequential>
    </for>
  </target>

  <target name="analyze-benchmarks">
    <dart_analyze file="example/benchmarks/BenchmarkRunner.dart" />
  </target>

  <target name="generate-doc" description="Generate DartDoc for library.">
    <dartdoc file="lib/box2d_nohtml.dart" outDir="doc" />
    <dartdoc file="lib/box2d.dart" outDir="doc" />
  </target>

  <target name="generate-JS"
    depends="generate-JS-demos, generate-JS-benchmarks"
    description="Run dart2js on all demos and benchmarks." />

  <target name="generate-JS-demos">
    <for param="file" trim="true" parallel="true" threadCount="${threadCount}">
      <path refid="demos" />
      <sequential>
        <dart2js file="@{file}" withChecks="${withChecks}" />
      </sequential>
    </for>
  </target>

  <target name="generate-JS-benchmarks">
    <dart2js file="example/benchmarks/BenchmarkRunner.dart"
      withChecks="${withChecks}" />
  </target>

</project>

